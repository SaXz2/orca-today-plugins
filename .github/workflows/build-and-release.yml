name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build plugin
      run: npm run build
      
    - name: Create plugin package
      run: |
        # åˆ›å»ºæ’ä»¶å‘å¸ƒç›®å½•
        mkdir -p orca-today-plugin
        
        # å¤åˆ¶å¿…è¦æ–‡ä»¶åˆ°æ’ä»¶ç›®å½•
        cp dist/index.js orca-today-plugin/
        cp package.json orca-today-plugin/
        cp README.md orca-today-plugin/
        
        # å¤åˆ¶å›¾æ ‡
        if [ -f icon.svg ]; then
          cp icon.svg orca-today-plugin/
        elif [ -f icon.png ]; then
          cp icon.png orca-today-plugin/
        else
          echo "No icon file found, skipping icon copy"
        fi
        
        # åˆ›å»ºå‹ç¼©åŒ…
        zip -r orca-today-plugin.zip orca-today-plugin/
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: orca-today-plugin
        path: orca-today-plugin.zip
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: orca-today-plugin.zip
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## ğŸ‰ Orca Today Plugin Release
          
          ### åŠŸèƒ½ç‰¹æ€§
          - ğŸ·ï¸ è‡ªåŠ¨æ ‡ç­¾ç®¡ç†ï¼šè‡ªåŠ¨æ£€æµ‹å’Œç®¡ç†å¸¦æœ‰ #Today æ ‡ç­¾çš„å—
          - ğŸ“… æ™ºèƒ½æ—¥æœŸæ›´æ–°ï¼šè‡ªåŠ¨ä¸º Today æ ‡ç­¾æ·»åŠ  date å±æ€§å¹¶ä¿æŒä¸ºå½“å‰æ—¥æœŸ
          - âš¡ å®æ—¶ç›‘æ§ï¼šæ¯30ç§’æ£€æŸ¥æ–°æ·»åŠ çš„ Today æ ‡ç­¾å¹¶ç«‹å³å¤„ç†
          - ğŸ”„ å®šæ—¶æ›´æ–°ï¼šæ¯1å°æ—¶è‡ªåŠ¨æ›´æ–°æ‰€æœ‰ Today æ ‡ç­¾çš„æ—¥æœŸå±æ€§
          - ğŸ¯ æ‰‹åŠ¨æ§åˆ¶ï¼šæä¾›å‘½ä»¤é¢æ¿å‘½ä»¤æ‰‹åŠ¨è§¦å‘æ›´æ–°
          - ğŸŒ å¤šè¯­è¨€æ”¯æŒï¼šæ”¯æŒä¸­æ–‡ç•Œé¢
          - ğŸ›¡ï¸ é”™è¯¯å¤„ç†ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
          
          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `orca-today-plugin.zip`
          2. è§£å‹åˆ° Orca Note çš„ `plugins` ç›®å½•
          3. é‡å¯ Orca Note
          4. åœ¨è®¾ç½®ä¸­å¯ç”¨æ’ä»¶
          
          ### ä½¿ç”¨æ–¹æ³•
          åœ¨ä»»æ„å—ä¸­æ·»åŠ  `#Today` æ ‡ç­¾ï¼Œæ’ä»¶ä¼šè‡ªåŠ¨å¤„ç†ã€‚
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
